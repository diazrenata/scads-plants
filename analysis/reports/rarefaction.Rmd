---
title: "Rarefaction/estimated richness report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(scadsplants)
library(SPECIES)

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", "drake-cache.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

```

## Developing a rarefaction protocol

```{r load stuff}
datnames <- cached(cache = cache)[ which(substr(cached(cache = cache), 1, 3) == "dat")]
datnames <- datnames[ !grepl(datnames, pattern = "singles")]

all_dats <- lapply(datnames, readd, cache = cache, character_only = T)

all_singletons <- lapply(all_dats, FUN = function(dat) return(try(add_singletons(dat)))) 

all_est_S <- lapply(all_singletons, FUN = function(dat)
  return(try(nrow(dat)))) 

head(all_dats[[3]])

all_freqs <- lapply(all_dats, FUN = function(dat_df) return(list(freq = dat_df %>%
                                                                   select(abund) %>%
                                                                   group_by(abund) %>%
                                                                   summarise(freq = n()) %>%
                                                                   as.matrix(),
                                                                 meta = data.frame(year = dat_df$year[1],
                                                                                   season = dat_df$season[1], stringsAsFactors = F))))

```

```{r rarefaction, fig.height = 3, fig.width = 6, warning = FALSE, message = FALSE}
all_ests <- lapply(all_freqs, FUN = function(freq_list)
  return(freq_list$meta %>%
           mutate(S = sum(freq_list$freq[,2]),
                  N = sum(freq_list$freq[,1] * freq_list$freq[,2]),
                  est_1984 = ifelse(sum(freq_list$freq[,2] > 2), chao1984(freq_list$freq)$Nhat, NA),
                  cb = ifelse(sum(freq_list$freq[,2] > 2), ChaoBunge(freq_list$freq, t = min(11, nrow(freq_list$freq) -1 ))$Nhat, NA),
                  clee = ifelse(sum(freq_list$freq[,2] > 2), mean(ChaoLee1992(freq_list$freq, t = min(11, nrow(freq_list$freq) - 1))$Nhat), NA)
           )))

all_ests <- bind_rows(all_ests)

all_ests <- all_ests %>%
  tidyr::gather(-year, -season, -S, -N, key = "estimator", value = "estimate")  %>%
  filter(!is.infinite(estimate),
         !is.na(estimate),
         !is.nan(estimate),
         estimate > 0) %>%
  group_by(year, season) %>%
  mutate(mean_est = mean(estimate)) %>%
  ungroup()

ests_plots <- ggplot(data = all_ests, aes(x = S, y = estimate, color = estimator)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  geom_abline(intercept = 0, slope = 1.1, color = "blue") +
  theme_bw() +
  facet_wrap(vars(season), ncol = 2, strip.position = "top") +
  ylim(0, max(all_ests$estimate, na.rm = T) + 5) +
  scale_color_viridis_d(end = .8)

ests_plots

ests_mean_plots <- ggplot(data = all_ests, aes(x = S, y = mean_est)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  geom_abline(intercept = 0, slope = 1.1, color = "blue") +
  theme_bw() +
  ylim(0, max(all_ests$mean_est, na.rm = T) + 5)

ests_mean_plots

```

```{r estimated statevars}

statevars <- all_ests %>%
  select(S, N, mean_est) %>%
  mutate(mean_est = ceiling(mean_est)) %>%
  mutate(est_N = N + (mean_est - S) + 1)

max(statevars$mean_est)
max(statevars$est_N)

function_statevars <- bind_rows(all_dats, .id= 'datname') %>%
  select(datname, season, year, rank) %>%
  group_by(datname, season, year) %>%
  summarize(S = max(rank)) %>%
  ungroup() %>%
  mutate(S_est = NA, datname = as.integer(datname)) %>%
  arrange(datname)

for(i in 1:nrow(function_statevars)) {
  if(is.integer(all_est_S[[i]])) {
    function_statevars$S_est[i] <- all_est_S[[i]]
  }
}

function_S <- ggplot(data = function_statevars, aes(x = S, y = S_est)) +
  geom_point() +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1) +
  geom_abline(intercept = 0, slope = 1.1, color = "blue")
function_S
```

The consensus from the various estimators looks like the 10% I initially added was conservative. 

```{r load sims}

load(here::here("analysis", "reports", "ranked_dis.Rds"))
fs_df <- read.csv(here::here("analysis", "drake", "fs_df.csv"), stringsAsFactors = F)

fs_df <- fs_df %>%
  filter(source == "observed") %>%
  group_by(fs_name, sim, season, year) %>%
  mutate(S = n(), 
         N = sum(abund)) %>%
  ungroup()

ranked_di_df <- ranked_di_df %>%
  filter(source == "observed") %>%
  select(-sim) %>%
  mutate(fs_name = substr(di_name, 4, nchar(di_name))) %>%
  left_join(fs_df, by = c("fs_name", "source", "season", "year", "treatment"))

ranked_di_long_fs <- ranked_di_df %>%
  select(-skew, -shannon, -simpson, -fs_name, -di_name, -sim, -treatment) %>%
  tidyr::gather(-source, -season, -singletons, -S, -N, -abund, -year, -rank, key = "variable", value = "value")
```

```{r plot singleton v raw, fig.height= 100, fig.width = 7}

rare_plots <- ggplot(data = ranked_di_long_fs, aes(x = rank, y = abund, group = singletons, color = value)) +
  geom_line() + 
  theme_bw() +
  facet_wrap(vars(year, season, variable), strip.position = "top", scales = "free", ncol = 3) +
  scale_color_viridis_c(end = .8, option = "plasma")

rare_plots
```

```{r s s}

di_change_df <- ranked_di_df %>%
  select(-di_name, -fs_name, -sim, -abund, -rank, -source, -treatment, -skew, -shannon, -simpson) %>%
  distinct()

di_change_df <- di_change_df %>%
  filter(singletons == "true") %>%
  select(-singletons) %>%
  left_join(
    select(
      filter(di_change_df, singletons != "true"), -singletons
    ), by = c("year", "season")
  ) %>%
  mutate(dS = S.y - S.x,
         dN = N.y - N.x,
         dskew_percentile = skew_percentile.y - skew_percentile.x,
         dshannon_percentile = shannon_percentile.y - shannon_percentile.x,
         dsimpson_percentile = simpson_percentile.y - simpson_percentile.x
         ) %>%
  mutate(dS_percent = dS/S.x)

dS_dskew <- ggplot(data = di_change_df, aes(x = S.x, y = dS_percent, color = dskew_percentile)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(end = .8)

dS_dskew
```

```{r why is 1998 wrong}
loadd(fs_dat_singles_dat_1998L_summer_control_10000_master_p_table, cache = cache)
fs_98 <- fs_dat_singles_dat_1998L_summer_control_10000_master_p_table %>%
  group_by(sim) %>%
  summarize(Nspp = n()) %>%
  ungroup()

head(fs_98)



loadd(dat_singles_dat_1998L_summer_control, cache = cache)

nrow(dat_singles_dat_1998L_summer_control)
dat_singles_dat_1998L_summer_control

loadd(dat_1998L_summer_control, cache = cache)

add_singletons(dat_singles_dat_1998L_summer_control)

```
