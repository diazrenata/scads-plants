---
title: "Rarefaction/estimated richness report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(scadsplants)
library(SPECIES)

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", "drake-cache.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

```

## Developing a rarefaction protocol

```{r load stuff}
datnames <- cached(cache = cache)[ which(substr(cached(cache = cache), 1, 3) == "dat")]
datnames <- datnames[ !grepl(datnames, pattern = "singles")]

dat <- readd(datnames[2], character_only = T,  cache = cache)

all_dats <- lapply(datnames, readd, cache = cache, character_only = T)

all_ests <- lapply(all_dats, FUN = function(a_dat) return(try(add_singletons(a_dat))))

all_ests <- all_ests[ which(!is.na(all_ests))]

alldat <- bind_rows(all_dats)
allests <- bind_rows(all_ests)

allests <- allests %>%
  group_by(sim, source, season, year, treatment) %>%
  summarize(n0 = sum(abund),
         s0 = n()) %>%
  ungroup() %>%
  select(season, year, s0, n0) %>%
  rename(est_n0 = n0,
         est_s0 = s0)

alldat <- alldat %>%
  group_by(sim, source, season, year, treatment) %>%
  summarize(n0 = sum(abund),
         s0 = n()) %>%
  ungroup() %>%
  select(season, year, s0, n0)

alldat <- left_join(alldat, allests, by = c("season", "year"))

```

```{r rarefaction, fig.height = 3, fig.width = 6, warning = FALSE, message = FALSE}

ests_plots <- ggplot(data = alldat, aes(x = s0, y = est_s0)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  geom_abline(intercept = 0, slope = 1.1, color = "blue") +
  theme_bw() +
  facet_wrap(vars(season), ncol = 2, strip.position = "top") +
  ylim(0, max(alldat$est_s0, na.rm = T) + 5)

ests_plots

max(alldat$est_s0, na.rm = T)
```


```{r load sims}

load(here::here("analysis", "reports", "ranked_dis.Rds"))
fs_df <- read.csv(here::here("analysis", "drake", "fs_df.csv"), stringsAsFactors = F)

fs_df <- fs_df %>%
  filter(source == "observed") %>%
  group_by(fs_name, sim, season, year) %>%
  mutate(S = n(), 
         N = sum(abund)) %>%
  ungroup()

ranked_di_df <- ranked_di_df %>%
  filter(source == "observed") %>%
  select(-sim) %>%
  mutate(fs_name = substr(di_name, 4, nchar(di_name))) %>%
  left_join(fs_df, by = c("fs_name", "source", "season", "year", "treatment"))

ranked_di_long_fs <- ranked_di_df %>%
  select(-skew, -shannon, -simpson, -fs_name, -di_name, -sim, -treatment) %>%
  tidyr::gather(-source, -season, -singletons, -S, -N, -abund, -year, -rank, key = "variable", value = "value")
```

```{r plot singleton v raw, fig.height= 100, fig.width = 7}

rare_plots <- ggplot(data = ranked_di_long_fs, aes(x = rank, y = abund, group = singletons, color = value)) +
  geom_line() + 
  theme_bw() +
  facet_wrap(vars(year, season, variable), strip.position = "top", scales = "free", ncol = 3) +
  scale_color_viridis_c(end = .8, option = "plasma")

rare_plots
```
